---
title: "PSet1"
author ID: "12174137"
date: "10/15/2018"
output:
  pdf_document: default
  html_document: default
---

# ID: 12174137

```{r setup, include=FALSE}
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
```
```{r loads, include=FALSE}
install.packages("rmarkdown")
install.packages("lmtest")
install.packages("stargazer")
install.packages("fastDummies")
library(tidyverse)
library(haven)
library(stargazer)
library(fastDummies)
mex_data <- read_dta(file='SP_dataset.dta')
```

## Problem Set 1 

### Question 1: Inspecting the Data

#### Are there truly 100 clusters and 50 pairs?

Yes there are. The two commands below print out the unique values for both columns and show that there are 100 clusters and 50 paits.

```{r 1a}
print(length(unique(mex_data$cluster)))
print(length(unique(mex_data$clust_pair)))
```

#### Does each pair have a treatment and control cluster?

Yes, as the code below shows. Each pair has both a 1 value and 0 value for the treatment column.

```{r 1b}
pair <- 1
while (pair < 51) {
  subs <- subset(mex_data, clust_pair == pair)
  print(unique(subs$treatment))
  pair <- pair + 1
}
```

#### What is the modal level of schooling in the sample

There is no modal level of schooling, since no totals repeat.

```{r 1c}
modal_list <- list(sum(mex_data$edu_info_051, na.rm=TRUE), sum(mex_data$edu_info_052, na.rm = TRUE), sum(mex_data$edu_info_053, na.rm = TRUE), sum(mex_data$edu_info_054, na.rm = TRUE), sum(mex_data$edu_info_055, na.rm = TRUE), sum(mex_data$edu_info_056, na.rm = TRUE))
print(modal_list)
```

#### What is the modal marital status?

```{r 1d}
uniq <- unique(mex_data$marstat, na.rm=TRUE)
print(uniq[which.max(tabulate(match(mex_data$marstat, uniq)))])
```

#### What shares of sample households were involved in Mexico's conditional cash program

In order to do this, I imputed missing values with zero.

```{r 1e}
mex_data$opor_05[is.na(mex_data$opor_05)] <- 0
print(sum(mex_data$opor_05) / length(mex_data$opor_05))
```

#### What is the mean non-health expenditure?

Imputed missing values as the median, since I found it problematic to impute missing values for food expenditures as zero

```{r 1f}
mex_data$allbut_05[is.na(mex_data$allbut_05)] = median(mex_data$allbut_05, na.rm=TRUE)
mex_data$allbut_06[is.na(mex_data$allbut_06)] = median(mex_data$allbut_06, na.rm=TRUE)
print(mean(mex_data$allbut_05))
print(mean(mex_data$allbut_06))
```



### Question 2: Which treatment parametes could be identified by these data?

We are unable to identify average treatment effects from this data since its taken from a largely rural population. That means we will not be able to estimate the effects of the program on urban recipients. Furthermore, enrollment in the program is voluntary, which means that means that we'd run into a selection problem if we deployed an ATE approach given that people who select into theprogram might have certain unobservable differences. This is why, from the data available, we can estimate average treatment effect on the treated and average treatment effect on the non-treated.



### Question 3: Assess the adequacy of random assignment.

Running a paired t-test on my 05 variables with treatment. 

```{r 3a}
pair <- 1
while (pair < 51) {
  subz <- subset(mex_data, clust_pair == pair)
  print(t.test(subz$food_yr_05, subz$treatment, paired=TRUE))
  print(t.test(subz$allbut_05, subz$treatment, paired=TRUE))
  print(t.test(subz$oop_yr3_05, subz$treatment, paired=TRUE))
  pair <- pair + 1
}
```

#### How important is it to account for dependence within cluster?

It's critically important to account for dependence within cluster, since not doing so would introduce multicolllinearity into the ultimate analysis.

#### What is the bottom line?

There is no real discernible difference between difference of means in the control group vs treatment group

#### Was random assignment properly executed?

In this case, random assignment was properly executed. All of the means of differences between the 05 variables for every cluster were within the 95% confidence interval.


### Question 4: Construct two variables relating health spending to total income

First step is filling in missing variables

```{r 4a}
mex_data$food_yr_05[is.na(mex_data$food_yr_05)] = median(mex_data$food_yr_05, na.rm=TRUE)
mex_data$food_yr_06[is.na(mex_data$food_yr_06)] = median(mex_data$food_yr_06, na.rm=TRUE)
mex_data$oop_yr3_05[is.na(mex_data$oop_yr3_05)] <- 0
mex_data$oop_yr3_06[is.na(mex_data$oop_yr3_06)] <- 0
```

Next step calculates the health budget share and appends to end of dataframe

```{r 4b}
mex_data$hbs_05 <- mex_data$oop_yr3_05 / (mex_data$food_yr_05 + mex_data$allbut_05 + mex_data$oop_yr3_05)
mex_data$hbs_06 <- mex_data$oop_yr3_06 / (mex_data$food_yr_06 + mex_data$allbut_06 + mex_data$oop_yr3_06)
```

Next step calculates the adjusted health spending and appends to end of dataframe

```{r 4c}
mex_data$adj_hbs_05 <- mex_data$oop_yr3_05 / (mex_data$allbut_05 + mex_data$oop_yr3_05)
mex_data$adj_hbs_06 <- mex_data$oop_yr3_06 / (mex_data$allbut_06 + mex_data$oop_yr3_06)
```

```{r}
head(mex_data, n=10)
```

### Question 5: On average, what share of total expenditures does health spending account for?

```{r 5a}
mex_data$hbs_05[is.na(mex_data$hbs_05)] <- 0
mex_data$hbs_06[is.na(mex_data$hbs_06)] <- 0

print('share for 05:') 
print(mean(mex_data$hbs_05))
print('share for 06:')
print(mean(mex_data$hbs_06))
```

#### What are the 75 and 90 percentile of the budget share distribution

```{r 5b}
print('percentiles 05:')
print(quantile(mex_data$hbs_05, c(.75, 0.9)))
print('percentiles 06:')
print(quantile(mex_data$hbs_06, c(.75, .90)))
```

#### What share of disposable income does health spending account for

```{r 5c}
mex_data$adj_hbs_05[is.na(mex_data$adj_hbs_05)] <- 0
mex_data$adj_hbs_06[is.na(mex_data$adj_hbs_06)] <- 0

print('adjustable share for 05:')
print(mean(mex_data$adj_hbs_05))
print('adjustable share for 06:')
print(mean(mex_data$adj_hbs_06))
```

#### What are the 75 and 90 percentile of adjusted budget distribution?

```{r 5d}
print('adjustable percentiles 05:')
print(quantile(mex_data$adj_hbs_05, c(.75, .9)))
print('adjustable percentiles 06:')
print(quantile(mex_data$adj_hbs_06, c(.75, .9)))
```


### Question 6: Construct two measures of extreme health spending

#### A dummy equal to one if household budget exceeds 0.2

```{r 6a}
mex_data$ext_hbs_05[mex_data$hbs_05 >= 0.2] <- 1
mex_data$ext_hbs_05[mex_data$hbs_05 < 0.2] <- 0

mex_data$ext_hbs_06[mex_data$hbs_06 >= 0.2] <- 1
mex_data$ext_hbs_06[mex_data$hbs_06 < 0.2] <- 0

```

#### A dummy equal to one if household health budget exceeds 0.3 as percent of disposable

```{r 6b}
mex_data$ext_ahbs_05[mex_data$adj_hbs_05 >= 0.3] <- 1
mex_data$ext_ahbs_05[mex_data$adj_hbs_05 < 0.3] <- 0

mex_data$ext_ahbs_06[mex_data$adj_hbs_06 >= 0.3] <- 1
mex_data$ext_ahbs_06[mex_data$adj_hbs_06 < 0.3] <- 0
```

```{r}
head(mex_data, n=10)
```


### Question 7: Estimate the ITT effects of the intervention on extreme health spending

#### Regress the extreme health spending on the treatment and calculate standard errors that account for dependence among households within clusters

```{r 7a}
regr05 <- lm(ext_hbs_05 ~ treatment, data = mex_data)
regr05adj <- lm(ext_ahbs_05 ~ treatment, data = mex_data)

regr06 <- lm(ext_hbs_06 ~ treatment, data = mex_data)
regr06adj <- lm(ext_ahbs_06 ~ treatment, data = mex_data)

stargazer(regr05, regr05adj, regr06, regr06adj, type="text", title = "Extreme Health on Treatment")
```

#### Add cluster-pair dummies, calculate standard errors that account for dependence among households within clusters

```{r 7b}
mex_data_dummies <- cbind(mex_data, fastDummies::dummy_cols(mex_data$clust_pair))

regr051 <- lm(ext_hbs_05 ~ treatment + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)
regr051adj <- lm(ext_ahbs_05 ~ treatment + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)

regr061 <- lm(ext_hbs_06 ~ treatment + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)
regr061adj <- lm(ext_ahbs_06 ~ treatment + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)

stargazer(regr051, regr051adj, regr061, regr061adj, type="text", title="Extremem Health on Treatment and Dummies")
```

#### What happens to coefficients and standard errors when adding dummies and why?

There is actually no discernible in the direction or magnitude of the coefficients or standard errors when you move the cluster pair column into 50 separate dummies (as is the definition of creating dummy variables, unless it's been oddly defined in this homework). This is likely because the cluster pairs have been effectively built to be independent of each other.

### Question 8: Now adjust for baseline characteristics

#### Without dummies

```{r 8a}
regr_base05 <- lm(ext_hbs_05 ~ treatment + sex + age + marstat + hhsize, data = mex_data_dummies)
regr_base05adj <- lm(ext_ahbs_05 ~ treatment + sex + age + marstat + hhsize, data = mex_data_dummies)

regr_base06 <- lm(ext_hbs_06 ~ treatment + sex + age + marstat + hhsize, data = mex_data_dummies)
regr_base06adj <- lm(ext_ahbs_06 ~ treatment + sex + age + marstat + hhsize, data = mex_data_dummies)

stargazer(regr_base05, regr_base05adj, regr_base06, regr_base06adj, type='text', title='Extreme Health on Treatment with Baseline')
```

#### With dummies

```{r}
regr05basedums <- lm(ext_hbs_05 ~ treatment + sex + age + marstat + hhsize + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)
regr05baseadjdums <- lm(ext_ahbs_05 ~ treatment + sex + age + marstat + hhsize + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)

regr06basedums <- lm(ext_hbs_06 ~ treatment + sex + age + marstat + hhsize+ .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)
regr06baseadjdums <- lm(ext_ahbs_06 ~ treatment + sex + age + marstat + hhsize + .data_1 + .data_2 + .data_3 + .data_4 + .data_5 + .data_6 + .data_7 + .data_8 + .data_9 + .data_10 + .data_11 + .data_12 + .data_13 + .data_14 + .data_15 + .data_16 + .data_16 + .data_17 + .data_18 + .data_19 + .data_20 + .data_21 + .data_22 + .data_23 + .data_24 + .data_25 + .data_26 + .data_27 + .data_28 + .data_29 + .data_30 + .data_31 + .data_32 + .data_33 + .data_34 + .data_35 + .data_36 + .data_37 + .data_38 + .data_39 + .data_40 + .data_41 + .data_42 + .data_43 + .data_44 + .data_45 + .data_46 + .data_47 + .data_48 + .data_49 + .data_50, data = mex_data_dummies)

stargazer(regr05basedums, regr05baseadjdums, regr06basedums, regr06baseadjdums, type='text', title='Extreme Health on Treatment with Dummies and Baseline')
```

#### What happens to the coefficients when you add cluster-pair dummies? What about the standard error?

As in question 8, there is not much change directionally or in magnitude of coefficient or standard error change once your control for the baseline measures of sex, age, hhsize, and marstat. This is again likely due independence within the clusters.

### Question 9: Are any of your conclusions sensitive to the way that you measure extreme health expenditures?

None of my conclusions are sensitive to the way that I measure extreme health expenditures since they all return the same coefficients and standard errors for treatment when accounting for different health expenditure variables, turning cluster pairs into dummies, or adding baselines such as sex, age, hhsize, and marstat.


### Question 10: Wald estimator and interpretation

If I could estimate it, you'd see that my interpretation of it would be incredible. But this is one of those chicken and the egg deals: I haven't been able to figure out how to compute it in R, therefore I can't interpret it...or is it the other way around?? :D



#NAME: MARIO MORENO
